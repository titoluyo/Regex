--exec sp_configure 'clr enabled',1
--reconfigure

--SELECT * FROM sys.objects WHERE name LIKE '%function%'

IF EXISTS(SELECT 1 FROM sys.assemblies WHERE name = 'tlm.SqlFunctions')
BEGIN
	DROP FUNCTION dbo.SqlFunction
	DROP FUNCTION dbo.RegexMatch
	DROP FUNCTION dbo.Test
	DROP ASSEMBLY [tlm.SqlFunctions]
END


CREATE ASSEMBLY [tlm.SqlFunctions] FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030025AB16580000000000000000E00002210B010B00001000000006000000000000FE2D0000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000B02D00004B00000000400000C802000000000000000000000000000000000000006000000C000000782C00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000040E0000002000000010000000020000000000000000000000000000200000602E72737263000000C8020000004000000004000000120000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001600000000000000000000000000004000004200000000000000000000000000000000E02D000000000000480000000200050074230000040900000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133003004400000001000011001B8D0F0000010B07167201000070A207170F00280500000AA207187205000070A207190F01280500000AA2071A7201000070A207280600000A730700000A0A2B00062A1B3002003B0000000200001100000F01280500000A7E04000004730800000A0A06026F0900000A730A00000A6F0B00000A280C00000A0BDE0B260016280C00000A0BDE0000072A0001100000000001002C2D000B010000011B300500910000000300001100170A000F00280D00000A0B7E01000004076F0E00000A130411042D2300160A7E01000004070F02280500000A7E040000041E60730800000A6F0F00000A00007209000070078C10000001068C110000017E01000004076F1000000A036F0900000A730A00000A6F0B00000A8C11000001281100000A281200000A0DDE100C00086F1300000A281200000A0DDE0000092A00000001100000000003007B7E001012000001133003006A00000004000011000F00281400000A2D150F01281400000A2D0C0F02281400000A16FE012B0116000C082D087E1500000A0B2B3B0F01FE16050000016F1600000A731700000A0A060F00FE16050000016F1600000A0F02FE16050000016F1600000A6F1800000A730700000A0B2B00072A0000133002007E00000005000011000F01280500000A7E04000004730800000A0A06026F0900000A730A00000A6F1900000A0B731A00000A0C2B350008076F1B00000A6F1C00000A26076F1D00000A0B076F1E00000A16FE01130411042D1000080F02280500000A6F1C00000A260000076F1E00000A130411042DBF086F1600000A730700000A0D2B00092A0000133002007D00000006000011000F01280500000A7E04000004730800000A0A06026F0900000A730A00000A6F1900000A0B72290000700C160D2B350009281F00000A04282000000A282100000A16FE01130511052D0E00076F1B00000A6F1600000A0C00076F1D00000A0B0917580D00076F1E00000A130511052DBF08730700000A13042B0011042AD6732200000A8001000004732300000A80020000047E0200000420E8030000200F2700006F2400000A80030000041F2280040000042A1E02282500000A2A0042534A4201000100000000000C00000076342E302E33303331390000000005006C00000058030000237E0000C40300008803000023537472696E6773000000004C0700002C0000002355530078070000100000002347554944000000880700007C01000023426C6F620000000000000002000001571502080900000000FA25330016000001000000170000000200000004000000080000001000000025000000090000000600000002000000010000000300000000000A00010000000000060044003D00060066004B000A00930074000600A2003D000E00D200BD000A00E80074000E00FD00BD000E000801BD000E001C01BD000600B601A3012B00CA0100000600F901D90106001902D9010E0063024802060078023D000600B9023D000600BF023D000600D7023D000A000E0374000600200314030A002E0374000A0047037400060074034B000000000001000000000001000100010010001F000000050001000100360099000A003600A90013003600AD0017003600F50023005020000000009600DC001A000100A020000000009600110127000300F820000000009600250130000500A8210000000096002A013B0008002022000000009600370146000B00AC22000000009600460151000E006B2300000000861855015C00110035230000000091186D0337011100000001005B01000002006001000001006501000002006B01000001007301000002006501000003006B01000001007601000002006B01000003008101000001006501000002006B01000003008901000001006501000002006B01000003009801510055016000610055016600690055015C00710055015C0029007F027000790089027400290055017A0019005501860041007F028D00790055019200190090029800390098029D0049007F02AA000C00A402B6000C00B002BC000C00C702C4007900D002CB0029009802D3009100E10270002900ED02E3002900F802E7000900FD027000190055017A0019000603EB0019000E03F900A10055015C00A9007F027000A1003603FF0099003D030501B1004D03E300490098021601490059031C01390065032501140055015C00210055015C00210081034301090055015C00200023006B002E000B0049012E00130052012E001B005B01400023006B00600023006B00800023006B00A00023006B00C00023006B007F00A300D900F1000A012B01AE003B0104800000000000000000000000000000000037020000040000000000000000000000010034000000000004000000000000000000000001003D00000000000400000000000000000000000100B100000000000000003C4D6F64756C653E00746C6D2E53716C46756E6374696F6E732E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E732E47656E65726963004944696374696F6E61727960320053797374656D2E546578742E526567756C617245787072657373696F6E73005265676578005061747465726E730052616E646F6D00726E640076616C0053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E670053716C46756E6374696F6E0052656765784F7074696F6E73004F7074696F6E730053716C426F6F6C65616E0053716C43686172730052656765784D617463680053716C496E74333200546573740052656765785265706C61636500526567657853656C656374416C6C00526567657853656C6563744F6E65002E63746F720073747231007374723200696E707574007061747465726E0069640065787072657373696F6E007265706C616365006D6174636844656C696D69746572006D61746368496E6465780053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500746C6D2E53716C46756E6374696F6E73004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500537472696E67006765745F56616C756500436F6E6361740049734D61746368006F705F496D706C6963697400436F6E7461696E734B6579007365745F4974656D00496E74333200426F6F6C65616E006765745F4974656D00466F726D617400457863657074696F6E006765745F4D657373616765006765745F49734E756C6C004E756C6C00546F537472696E67005265706C616365004D617463680053797374656D2E5465787400537472696E674275696C646572004361707475726500417070656E64004E6578744D617463680047726F7570006765745F53756363657373006F705F457175616C697479006F705F54727565002E6363746F720044696374696F6E6172796032004E65787400000000032B0000037C00001F7B0030007D0020002D0020007B0031007D0020002D0020007B0032007D0001010000394D899ABA741A4A97124FBD904AED600008B77A5C561934E08908061512090208120D0306121102060808000211151115111503061119080002111D122111150A000311151125122111150A000311151115111511150A000311151221111511150A000311151221111511250320000105200101112D042001010804010000000320000E0500010E1D0E042001010E06070211151D0E062002010E11190420001D03052001011D03042001020E050001111D02060702120D111D03200008071512090208120D0520010213000720020113001301062001130113000700040E0E1C1C1C05000111150E0907050208124911150203200002030611150520020E0E0E070703120D111502052001124D0E05200112510E042000124D0B0705120D124D1251111502050001112508080002111D1125112505000102111D0B0706120D124D0E08111502030000010715125D0208120D0520020808080801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000000025AB165800000000020000001C010000942C0000940E000052534453BB5BC8A1153096459D6AF4949FAD8BBB07000000643A5C4675656E7465735C5F636F64655C53716C436C725C746C6D2E53716C46756E6374696F6E735C6F626A5C44656275675C746C6D2E53716C46756E6374696F6E732E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D82D00000000000000000000EE2D0000002000000000000000000000000000000000000000000000E02D00000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000006C02000000000000000000006C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004CC010000010053007400720069006E006700460069006C00650049006E0066006F000000A801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000004C001500010049006E007400650072006E0061006C004E0061006D006500000074006C006D002E00530071006C00460075006E006300740069006F006E0073002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005400150001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000074006C006D002E00530071006C00460075006E006300740069006F006E0073002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000003E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 WITH PERMISSION_SET = SAFE
GO

CREATE FUNCTION dbo.SqlFunction(@str1 NVARCHAR(max), @str2 NVARCHAR(max)) 
RETURNS NVARCHAR(max)
AS 
EXTERNAL NAME [tlm.SqlFunctions].UserDefinedFunctions.SqlFunction
GO

CREATE FUNCTION dbo.RegexMatch(@input NVARCHAR(max), @pattern NVARCHAR(max))
RETURNS BIT
AS
EXTERNAL NAME [tlm.SqlFunctions].UserDefinedFunctions.RegexMatch
GO

CREATE FUNCTION dbo.Test(@id INT, @str1 NVARCHAR(max), @str2 NVARCHAR(max))
RETURNS NVARCHAR(max)
AS
EXTERNAL NAME [tlm.SqlFunctions].UserDefinedFunctions.Test
GO

--SELECT dbo.SqlFunction('Hola', 'Mundo');

--DECLARE @input NVARCHAR(max), @pattern NVARCHAR(max)
--SET @input = N'1'
--SET @pattern = N'^\d$'
--SELECT dbo.RegexMatch(@input,@pattern)
SELECT 
	--dbo.Test(R.ID, RTRIM(R.Matched),R.Expression) AS Test1, 
	--dbo.Test(R.ID, RTRIM(R.NonMatched),R.Expression) AS Test2, 
--	dbo.SqlFunction(RTRIM(R.Matched),R.Expression), 
	dbo.RegexMatch(RTRIM(R.Matched),R.Expression),
	dbo.RegexMatch(RTRIM(R.NonMatched),R.Expression),
	R.Matched,
	R.Expression 
FROM RegexLib R WITH (NOLOCK)
